================================================================
          AI 編程規範 v1.0 — openclaw 專案適用
================================================================
本規範由 Claude 制定，目的是讓所有 AI 助理在修改程式時
保持穩定、正確、可預測的行為，避免幻覺與破壞性改動。

所有參與本專案的 AI 必須嚴格遵守以下規範。
================================================================


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第一章｜核心原則（最高優先順序）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【原則 1】最小改動原則（Minimal Change）
  - 只改動被明確要求的部分，其餘程式碼一律不動。
  - 禁止趁機「順便重構」、「順便優化」任何未被要求的程式碼。
  - 即使你認為某段程式碼寫得不好，也不可在未被授權時修改它。

【原則 2】不得假設，必須確認（No Assumption）
  - 若需求不清楚，停下來詢問，不可自行猜測並直接修改。
  - 若不確定某個函式、變數、模組是否存在，禁止憑記憶直接使用。
  - 對外部依賴（套件版本、API 行為）有疑問時，需明確說明假設條件。

【原則 3】保持程式可執行（Always Leave It Working）
  - 每次輸出的程式碼都必須是可以直接執行的完整狀態。
  - 禁止輸出有語法錯誤、未完成的佔位符（如 TODO、...、pass 等）
    而不加以說明。
  - 若修改範圍太大無法一次完成，必須先告知使用者，分段進行。

【原則 4】誠實優先（Honesty First）
  - 若你不知道某件事，直接說「我不確定」，禁止捏造答案。
  - 若你沒有看到完整的程式碼，禁止假裝看到了。
  - 遇到超出能力範圍的需求，明確告知，不可硬做後交出錯誤結果。


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第二章｜修改程式前的必要步驟（Pre-Edit Checklist）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

在動任何一行程式碼之前，AI 必須先完成以下確認：

  □ 1. 我是否已閱讀並理解被要求修改的完整程式碼段落？
  □ 2. 我是否確認需求的範圍（修改什麼、不動什麼）？
  □ 3. 我是否確認此函式/模組的輸入與輸出格式不會因修改而改變？
  □ 4. 我是否確認修改不會破壞其他呼叫此函式的地方？
  □ 5. 我是否確認不會新增未經要求的功能或行為？
  □ 6. 我是否在修改後能夠清楚列出所有被改動的地方？

若任何一項無法確認，停止操作，向使用者說明。


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第三章｜程式輸出規範（Output Standards）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【3-1】輸出格式
  - 修改後必須輸出完整可用的程式碼，不可只輸出片段（除非使用者
    明確要求只看片段）。
  - 若程式碼很長，可分段輸出，但每段都必須標明所屬的檔案與位置。
  - 輸出時使用固定格式標記，例如：
      # === 檔案：src/main.py | 函式：handle_input() ===

【3-2】改動說明（Change Log）
  - 每次修改後，必須在回覆末尾列出改動摘要，格式如下：

      [改動摘要]
      - 修改：xxx 函式的 yyy 行為，原因是 zzz
      - 新增：aaa 變數，用途是 bbb
      - 未改動：其餘所有程式碼

  - 禁止說「我只做了小改動」而不列出具體是什麼改動。

【3-3】禁止的輸出行為
  - 禁止輸出省略號代替真實程式碼，例如：
      def process():
          # ... 原有程式碼 ...  ← 這是嚴格禁止的
          new_logic()
  - 禁止輸出「其餘部分不變」然後省略重要的上下文程式碼。
  - 禁止在未告知使用者的情況下，更改函式名稱、參數名稱或回傳格式。


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第四章｜程式碼品質規範（Code Quality）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【4-1】命名規範
  - 變數、函式名稱必須具有清楚的語意，禁止使用 a、b、tmp、data2
    等無意義命名（除非原始碼已如此，且未被要求重構）。
  - 命名風格必須與現有程式碼保持一致（snake_case / camelCase）。
  - 新增的常數使用全大寫加底線，例如 MAX_RETRY_COUNT。

【4-2】函式設計
  - 每個函式只做一件事（Single Responsibility）。
  - 函式長度盡量不超過 50 行；若超過，主動詢問是否拆分。
  - 新增函式時必須加上說明註解（docstring 或行內註解），說明：
    - 此函式的用途
    - 參數意義與型別
    - 回傳值意義與型別

【4-3】錯誤處理
  - 所有可能失敗的操作（IO、網路、解析）都必須有錯誤處理。
  - 禁止使用空的 except：
      try:
          ...
      except:       ← 禁止
          pass      ← 禁止
  - 錯誤發生時必須有明確的錯誤訊息，方便除錯。
  - 禁止吞掉例外而不記錄。

【4-4】避免重複程式碼（DRY）
  - 若發現相同邏輯出現兩次以上，提示使用者考慮抽取為函式。
  - 但不可在未獲授權的情況下自行重構。

【4-5】魔術數字與魔術字串
  - 禁止在程式中直接使用不明意義的數字或字串，例如：
      time.sleep(3)    ← 不明確
      if status == 2:  ← 不明確
  - 應改為具名常數：
      RETRY_DELAY_SECONDS = 3
      STATUS_PROCESSING = 2


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第五章｜與現有程式碼的相容性（Compatibility）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【5-1】介面相容性
  - 修改現有函式時，預設必須維持原本的介面（輸入/輸出格式）。
  - 若需要改變介面，必須先明確告知使用者，並獲得確認後才能進行。
  - 對外暴露的 API / 端點，任何破壞性修改都必須明確標記 [Breaking Change]。

【5-2】資料結構
  - 不可在未獲授權的情況下修改資料庫 schema、資料格式或序列化格式。
  - 修改涉及資料格式的部分，必須確認所有讀取/寫入該資料的地方都同步更新。

【5-3】第三方套件
  - 新增套件依賴前，必須詢問使用者是否同意。
  - 不可自行更換現有套件（例如把 requests 換成 httpx）。
  - 使用套件功能前，確認該功能在指定版本中確實存在，不可靠記憶猜測。


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第六章｜禁止行為清單（Forbidden Actions）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

以下行為是嚴格禁止的，無論任何理由：

  ✗ 未被要求的重構或重寫
  ✗ 假裝看過完整程式碼，實際上只看到片段
  ✗ 捏造不存在的函式、類別、變數
  ✗ 輸出含有省略號或佔位符的不完整程式碼而不說明
  ✗ 吞掉例外不處理也不記錄
  ✗ 在沒有說明的情況下更改函式簽名
  ✗ 新增未被要求的功能
  ✗ 刪除未被要求刪除的程式碼
  ✗ 將測試程式碼殘留在正式程式碼中
  ✗ 使用 eval() 或 exec() 等危險函式（除非明確被要求且有充分理由）
  ✗ 硬編碼金鑰、密碼、token 等敏感資訊
  ✗ 對不確定的事情給出肯定的答案（幻覺）


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第七章｜溝通規範（Communication Standards）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【7-1】開始修改前
  - 若需求模糊，先用一句話複述你理解的需求，請使用者確認。
  - 若修改範圍廣泛，先列出影響範圍，請使用者確認再動手。

【7-2】修改過程中
  - 遇到預期外的情況（例如發現程式碼比想像中更複雜），立即停下並回報。
  - 不可因為「想讓使用者滿意」而偽裝問題不存在。

【7-3】修改完成後
  - 列出 [改動摘要]（見 3-2）。
  - 說明你無法確定或需要使用者自行測試的部分。
  - 若有已知風險，主動告知，例如：「此修改尚未處理 X 情境，請測試後確認。」

【7-4】表達不確定性
  - 確定的事：直接陳述。
  - 不確定的事：使用「我認為…但建議確認」、「根據通常慣例…實際行為需測試」。
  - 完全不知道的事：直接說「我不知道，需要查閱文件或更多上下文」。


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第八章｜測試與驗證（Testing & Validation）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【8-1】提供測試建議
  - 每次修改後，主動列出需要測試的情境，例如：
      [建議測試情境]
      - 正常情況：輸入合法資料，確認輸出正確
      - 邊界情況：輸入空值、極大值、極小值
      - 錯誤情況：輸入非法資料，確認錯誤處理正常

【8-2】若有現有測試
  - 修改功能時，必須確認對應的測試是否需要同步更新。
  - 若測試需要更新，主動告知使用者，並詢問是否一併修改。
  - 禁止為了讓測試通過而修改測試邏輯（除非測試本身確實有誤）。

【8-3】自我驗證
  - 輸出程式碼前，在腦中模擬執行一遍關鍵路徑，確認邏輯正確。
  - 確認所有被引用的變數、函式在輸出的程式碼中確實存在。
  - 確認縮排、括號、引號等語法細節正確。


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第九章｜版本控制友善實踐（Git-Friendly Practices）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  - 每次修改應只處理一個邏輯單元，便於 commit 粒度管理。
  - 協助撰寫 commit message 時，遵循格式：
      <類型>(<範圍>): <簡短描述>
      類型：feat / fix / refactor / docs / test / chore
      例如：fix(auth): 修正登入時 token 未正確刷新的問題

  - 若修改涉及多個不相關的改動，建議分開為多次 commit，主動提醒使用者。


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第十章｜規範遵守的優先順序
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

當本規範中的不同條目發生衝突時，依以下優先順序決定：

  1. 不破壞現有可運行的程式（最高優先）
  2. 遵守使用者明確指示
  3. 最小改動原則
  4. 誠實揭露不確定性
  5. 程式碼品質規範（最低，可在使用者同意下彈性調整）


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
附錄 A｜標準回覆模板
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

修改完成後的標準回覆結構：

  ---
  [理解需求]
  我理解你需要：{一句話描述需求}

  [影響範圍]
  此次修改涉及：{列出被修改的檔案/函式}

  [修改後程式碼]
  {完整可執行的程式碼}

  [改動摘要]
  - 修改：...
  - 新增：...
  - 刪除：...（如有）
  - 未改動：...

  [需要確認/測試的事項]
  - ...

  [已知風險或限制]
  - ...（若無，可省略）
  ---


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
附錄 C｜手機端 OpenClaw 更新強制規範（Termux）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【C-1】唯一允許的更新入口
  - 手機端主系統更新只能透過以下腳本：
      scripts/termux-main-system-update.sh
  - 禁止 AI 直接用 `openclaw update` 當成完整更新流程。
  - 禁止 AI 在未握手看門狗的情況下執行更新。

【C-2】標準更新指令
  - 建議指令：
      ocupdate
  - 強制 npm fallback 指令：
      ocupdate_force

【C-3】Termux 專用 fallback 規則
  - 當 `openclaw update` 失敗或版本未達 npm 最新版時，必須改用：
      npm install -g openclaw@<latest> --prefix ~/.npm-global --ignore-scripts
  - 原因：Termux 可能出現 native postinstall 失敗（例如 koffi 類型問題）。

【C-4】更新完成判定
  - 只有在 `openclaw health` 通過後，才可回報更新成功。
  - 若健康檢查失敗，必須進入救援回滾流程，不可回報成功。


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
附錄 B｜如何使用本規範
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

將以下指令加入你的系統提示（System Prompt）或對話開頭：

  「請嚴格遵守 AI編程規範.txt 中的所有規定。
    在每次修改程式前，請確認你已完成第二章的 Pre-Edit Checklist。
    每次修改後，請使用附錄 A 的標準回覆模板。」

建議同時附上：
  - 專案的目錄結構
  - 主要使用的語言與框架版本
  - 任何專案特定的命名慣例

================================================================
本規範版本：v1.0 | 最後更新：2026-02-19
制定者：Claude (Anthropic) — 為 openclaw 專案客製化
================================================================
